From 2898ff5ca03063e401e03a3d5256a45026d820fc Mon Sep 17 00:00:00 2001
From: Chih-Wei Huang <cwhuang@linux.org.tw>
Date: Fri, 18 Jun 2021 16:30:30 +0800
Subject: [PATCH] Android: Add make and config files

Squashed version of several patches from raspberry-vanilla project [1]

[1]: https://github.com/raspberry-vanilla/android_external_alsa-lib/commit/eaa49b1327a50380e36be8f3667da73174e9c72c

Change-Id: I2250310eeea2b18e5b7376124ad6f0b731d84c03
---
 .gitignore          |   2 -
 Android.bp          |  47 +++++++++
 android/alsa        |   1 +
 android/config.h    | 232 ++++++++++++++++++++++++++++++++++++++++++++
 include/asoundlib.h |  60 ++++++++++++
 include/version.h   |   7 ++
 src/conf/alsa.conf  |   4 +-
 7 files changed, 349 insertions(+), 4 deletions(-)
 create mode 100644 Android.bp
 create mode 120000 android/alsa
 create mode 100644 android/config.h
 create mode 100644 include/asoundlib.h
 create mode 100644 include/version.h

diff --git a/.gitignore b/.gitignore
index 88d6b6ad..54551c79 100644
--- a/.gitignore
+++ b/.gitignore
@@ -31,9 +31,7 @@ ltconfig
 include/config.h
 include/stamp-h1
 include/stamp-vh
-include/version.h
 include/alsa
-include/asoundlib.h
 utils/alsa-lib.spec
 alsalisp/alsalisp
 aserver/aserver
diff --git a/Android.bp b/Android.bp
new file mode 100644
index 00000000..49ff00b8
--- /dev/null
+++ b/Android.bp
@@ -0,0 +1,47 @@
+//
+// Copyright (C) 2021 The Android-x86 Open Source Project
+// Copyright (C) 2023 KonstaKANG
+//
+// Licensed under the GNU Lesser General Public License Version 2.1.
+// You may not use this file except in compliance with the License.
+// You may obtain a copy of the License at
+//
+//      http://www.gnu.org/licenses/lgpl.html
+//
+
+cc_library_shared {
+    name: "libasound",
+    vendor: true,
+
+    cflags: [
+        "-DPIC",
+        "-Wno-absolute-value",
+        "-Wno-address-of-packed-member",
+        "-Wno-missing-braces",
+        "-Wno-missing-field-initializers",
+        "-Wno-pointer-arith",
+        "-Wno-sign-compare",
+        "-Wno-unused-function",
+        "-Wno-unused-const-variable",
+        "-Wno-unused-parameter",
+        "-Wno-unused-variable",
+        "-finline-limit=300",
+        "-finline-functions",
+        "-fno-inline-functions-called-once",
+    ],
+
+    srcs: ["src/**/*.c"],
+    exclude_srcs: [
+        "src/alisp/alisp_snd.c",
+        "src/compat/hsearch_r.c",
+        "src/control/control_shm.c",
+        "src/pcm/pcm_d*.c",
+        "src/pcm/pcm_ladspa.c",
+        "src/pcm/pcm_shm.c",
+        "src/pcm/scopes/level.c",
+    ],
+
+    local_include_dirs: ["include"],
+    export_include_dirs: ["android"],
+    shared_libs: ["libdl"],
+}
diff --git a/android/alsa b/android/alsa
new file mode 120000
index 00000000..f5030fe8
--- /dev/null
+++ b/android/alsa
@@ -0,0 +1 @@
+../include
\ No newline at end of file
diff --git a/android/config.h b/android/config.h
new file mode 100644
index 00000000..81ecff74
--- /dev/null
+++ b/android/config.h
@@ -0,0 +1,232 @@
+/* include/config.h.  Generated from config.h.in by configure.  */
+/* include/config.h.in.  Generated from configure.ac by autoheader.  */
+
+/* Directory with aload* device files */
+#define ALOAD_DEVICE_DIRECTORY "/dev/"
+
+/* directory containing ALSA configuration database */
+#define ALSA_CONFIG_DIR "/vendor/etc/alsa"
+
+/* Enable assert at error message handler */
+/* #undef ALSA_DEBUG_ASSERT */
+
+/* Directory with ALSA device files */
+#define ALSA_DEVICE_DIRECTORY "/dev/snd/"
+
+/* directory containing ALSA add-on modules */
+#define ALSA_PLUGIN_DIR "/vendor/etc/alsa/lib/alsa-lib"
+
+/* Build hwdep component */
+#define BUILD_HWDEP "1"
+
+/* Build mixer component */
+#define BUILD_MIXER "1"
+
+/* Build PCM component */
+#define BUILD_PCM "1"
+
+/* Build PCM adpcm plugin */
+#define BUILD_PCM_PLUGIN_ADPCM "1"
+
+/* Build PCM alaw plugin */
+#define BUILD_PCM_PLUGIN_ALAW "1"
+
+/* Build PCM lfloat plugin */
+#define BUILD_PCM_PLUGIN_LFLOAT "1"
+
+/* Build PCM mmap-emul plugin */
+#define BUILD_PCM_PLUGIN_MMAP_EMUL "1"
+
+/* Build PCM mulaw plugin */
+#define BUILD_PCM_PLUGIN_MULAW "1"
+
+/* Build PCM rate plugin */
+#define BUILD_PCM_PLUGIN_RATE "1"
+
+/* Build PCM route plugin */
+#define BUILD_PCM_PLUGIN_ROUTE "1"
+
+/* Build raw MIDI component */
+/* #undef BUILD_RAWMIDI */
+
+/* Build sequencer component */
+/* #undef BUILD_SEQ */
+
+/* Build DSP Topology component */
+#define BUILD_TOPOLOGY "1"
+
+/* Build UCM component */
+#define BUILD_UCM "1"
+
+/* Have clock gettime */
+#define HAVE_CLOCK_GETTIME 1
+
+/* Define to 1 if you have the <dlfcn.h> header file. */
+#define HAVE_DLFCN_H 1
+
+/* Define to 1 if you have the `eaccess' function. */
+/* #undef HAVE_EACCESS */
+
+/* Define to 1 if you have the <endian.h> header file. */
+#define HAVE_ENDIAN_H 1
+
+/* Define to 1 if you have the <inttypes.h> header file. */
+#define HAVE_INTTYPES_H 1
+
+/* Have LFS */
+#define HAVE_LFS 1
+
+/* Have libdl */
+#define HAVE_LIBDL 1
+
+/* Have libpthread */
+#define HAVE_LIBPTHREAD 1
+
+/* Define to 1 if you have the `resmgr' library (-lresmgr). */
+/* #undef HAVE_LIBRESMGR */
+
+/* Have librt */
+/* #undef HAVE_LIBRT */
+
+/* Define to 1 if you have the <malloc.h> header file. */
+#define HAVE_MALLOC_H 1
+
+/* Define to 1 if you have the <memory.h> header file. */
+#define HAVE_MEMORY_H 1
+
+/* MMX technology is enabled */
+#define HAVE_MMX "1"
+
+/* Define if your pthreads implementation have PTHREAD_MUTEX_RECURSIVE */
+#define HAVE_PTHREAD_MUTEX_RECURSIVE /**/
+
+/* Avoid calculation in float */
+/* #undef HAVE_SOFT_FLOAT */
+
+/* Define to 1 if you have the <stdint.h> header file. */
+#define HAVE_STDINT_H 1
+
+/* Define to 1 if you have the <stdlib.h> header file. */
+#define HAVE_STDLIB_H 1
+
+/* Define to 1 if you have the <strings.h> header file. */
+#define HAVE_STRINGS_H 1
+
+/* Define to 1 if you have the <string.h> header file. */
+#define HAVE_STRING_H 1
+
+/* Define to 1 if you have the <sys/endian.h> header file. */
+/* #undef HAVE_SYS_ENDIAN_H */
+
+/* Define to 1 if you have the <sys/shm.h> header file. */
+#define HAVE_SYS_SHM_H 1
+
+/* Define to 1 if you have the <sys/stat.h> header file. */
+#define HAVE_SYS_STAT_H 1
+
+/* Define to 1 if you have the <sys/types.h> header file. */
+#define HAVE_SYS_TYPES_H 1
+
+/* Define to 1 if you have the <unistd.h> header file. */
+#define HAVE_UNISTD_H 1
+
+/* Define to 1 if you have the `uselocale' function. */
+#define HAVE_USELOCALE 1
+
+/* Enable use of wordexp */
+/* #undef HAVE_WORDEXP */
+
+/* Define to 1 if compiler supports __thread */
+#define HAVE___THREAD 1
+
+/* Lockless dmix as default */
+/* #undef LOCKLESS_DMIX_DEFAULT */
+
+/* Define to the sub-directory where libtool stores uninstalled libraries. */
+#define LT_OBJDIR ".libs/"
+
+/* No assert debug */
+/* #undef NDEBUG */
+
+/* Name of package */
+#define PACKAGE "alsa-lib"
+
+/* Define to the address where bug reports for this package should be sent. */
+#define PACKAGE_BUGREPORT ""
+
+/* Define to the full name of this package. */
+#define PACKAGE_NAME "alsa-lib"
+
+/* Define to the one symbol short name of this package. */
+#define PACKAGE_TARNAME "alsa-lib"
+
+/* Define to the home page for this package. */
+#define PACKAGE_URL ""
+
+/* Max number of cards */
+#define SND_MAX_CARDS 32
+
+/* Define to 1 if you have the ANSI C header files. */
+#define STDC_HEADERS 1
+
+/* Support /dev/aload* access for auto-loading */
+/* #undef SUPPORT_ALOAD */
+
+/* Support resmgr with alsa-lib */
+/* #undef SUPPORT_RESMGR */
+
+/* Disable thread-safe API functions */
+#define THREAD_SAFE_API "1"
+
+/* Define to 1 if you can safely include both <sys/time.h> and <time.h>. */
+#define TIME_WITH_SYS_TIME 1
+
+/* directory to put tmp socket files */
+#define TMPDIR "/tmp"
+
+/* Enable extensions on AIX 3, Interix.  */
+#ifndef _ALL_SOURCE
+# define _ALL_SOURCE 1
+#endif
+/* Enable GNU extensions on systems that have them.  */
+#ifndef _GNU_SOURCE
+# define _GNU_SOURCE 1
+#endif
+/* Enable threading extensions on Solaris.  */
+#ifndef _POSIX_PTHREAD_SEMANTICS
+# define _POSIX_PTHREAD_SEMANTICS 1
+#endif
+/* Enable extensions on HP NonStop.  */
+#ifndef _TANDEM_SOURCE
+# define _TANDEM_SOURCE 1
+#endif
+/* Enable general extensions on Solaris.  */
+#ifndef __EXTENSIONS__
+# define __EXTENSIONS__ 1
+#endif
+
+
+/* compiled with versioned symbols */
+/* #undef VERSIONED_SYMBOLS */
+
+/* Define to 1 if on MINIX. */
+/* #undef _MINIX */
+
+/* Define to 2 if the system does not provide POSIX.1 features except with
+   this defined. */
+/* #undef _POSIX_1_SOURCE */
+
+/* Define to 1 if you need to in order for `stat' and other things to work. */
+/* #undef _POSIX_SOURCE */
+
+/* Toolchain Symbol Prefix */
+#define __SYMBOL_PREFIX ""
+
+/* Define to empty if `const' does not conform to ANSI C. */
+/* #undef const */
+
+/* Define to `__inline__' or `__inline' if that's what the C compiler
+   calls it, or to nothing if 'inline' is not supported under any name.  */
+#ifndef __cplusplus
+/* #undef inline */
+#endif
diff --git a/include/asoundlib.h b/include/asoundlib.h
new file mode 100644
index 00000000..de1fdb0b
--- /dev/null
+++ b/include/asoundlib.h
@@ -0,0 +1,60 @@
+/**
+ * \file include/asoundlib.h
+ * \brief Application interface library for the ALSA driver
+ * \author Jaroslav Kysela <perex@perex.cz>
+ * \author Abramo Bagnara <abramo@alsa-project.org>
+ * \author Takashi Iwai <tiwai@suse.de>
+ * \date 1998-2001
+ *
+ * Application interface library for the ALSA driver
+ */
+/*
+ *   This library is free software; you can redistribute it and/or modify
+ *   it under the terms of the GNU Lesser General Public License as
+ *   published by the Free Software Foundation; either version 2.1 of
+ *   the License, or (at your option) any later version.
+ *
+ *   This program is distributed in the hope that it will be useful,
+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of
+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ *   GNU Lesser General Public License for more details.
+ *
+ *   You should have received a copy of the GNU Lesser General Public
+ *   License along with this library; if not, write to the Free Software
+ *   Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA
+ *
+ */
+
+#ifndef __ASOUNDLIB_H
+#define __ASOUNDLIB_H
+
+#include <unistd.h>
+#include <stdio.h>
+#include <stdlib.h>
+#include <sys/types.h>
+#include <string.h>
+#include <fcntl.h>
+#include <assert.h>
+#include <poll.h>
+#include <errno.h>
+#include <stdarg.h>
+#include <endian.h>
+#include <alsa/asoundef.h>
+#include <alsa/version.h>
+#include <alsa/global.h>
+#include <alsa/input.h>
+#include <alsa/output.h>
+#include <alsa/error.h>
+#include <alsa/conf.h>
+#include <alsa/pcm.h>
+#include <alsa/rawmidi.h>
+#include <alsa/timer.h>
+#include <alsa/hwdep.h>
+#include <alsa/control.h>
+#include <alsa/mixer.h>
+#include <alsa/seq_event.h>
+#include <alsa/seq.h>
+#include <alsa/seqmid.h>
+#include <alsa/seq_midi_event.h>
+
+#endif /* __ASOUNDLIB_H */
diff --git a/include/version.h b/include/version.h
new file mode 100644
index 00000000..ab57d412
--- /dev/null
+++ b/include/version.h
@@ -0,0 +1,7 @@
+#define SND_LIB_MAJOR 1
+#define SND_LIB_MINOR 2
+#define SND_LIB_SUBMINOR 8
+#define SND_LIB_EXTRAVER 1000000
+#define SND_LIB_VER(maj, min, sub) (((maj)<<16)|((min)<<8)|(sub))
+#define SND_LIB_VERSION SND_LIB_VER(SND_LIB_MAJOR, SND_LIB_MINOR, SND_LIB_SUBMINOR)
+#define SND_LIB_VERSION_STR "1.2.8"
diff --git a/src/conf/alsa.conf b/src/conf/alsa.conf
index e65bf2ca..7e5ce81e 100644
--- a/src/conf/alsa.conf
+++ b/src/conf/alsa.conf
@@ -10,8 +10,8 @@
 		files [
 			"/var/lib/alsa/conf.d"
 			"/usr/etc/alsa/conf.d"
-			"/etc/alsa/conf.d"
-			"/etc/asound.conf|||/usr/etc/asound.conf"
+			"/vendor/etc/alsa/conf.d"
+			"/vendor/etc/asound.conf|||/usr/etc/asound.conf"
 			"~/.asoundrc"
 			{
 				@func concat
-- 
2.34.1

